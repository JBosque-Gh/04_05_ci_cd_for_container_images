
name: "3-Deployment"

on:
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: choice
        description: Select target environment
        options:
        - Staging
        - Production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    concurrency:
      group: deploy-${{ inputs.environment }}
      cancel-in-progress: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: |
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          docker build -t ${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:latest .

      - name: Push Docker image to GHCR
        run: |
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          docker push ${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:latest

      - name: Notify Render Deployment
        run: |
          echo "Image pushed to GHCR for ${{ inputs.environment }} environment."
          echo "Render will automatically build and deploy from the repo using Dockerfile."
